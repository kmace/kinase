## The full linear model of Condition and Stress identity accurately describes gene expression data
(or at least for most genes)

1. What's happening: I'm going to build the linear model
2. I'm going to show that it has good performance over most genes. 

### Building the models:

For every gene, we build a linear model to predict gene expression. The inputs to this model are the sample metadata (Condition and Kinase inhibiiton). Although sometimes unrealistic, these models assume that changes in gene expression can be computed by adding up the individual effects provided by the condiiton, and from the kinase.  For example:

for a gene that goes up 4X in from YPD to salt (+2 log2), and goes up 2X when PKA is inhibited (+1 log2), the model would expect the gene to be 8X increased in both Salt and PKA (+3 log2)

```{r ref.label='create_linear_models', eval = FALSE}
```
So we've built a model for each gene. lets quickly look at the data frame 


```{r}
colnames(genes)
```

In order to asses the quality for each fit, lets calculate the $R^2$, or the percentage of variance explained for each gene from the model.

```{r ref.label= 'model_quality', eval=FALSE}
```

Lets look at the $R^{2}$ for each gene in the full model:

```{r}
model_quality %>% 
    filter(model_type == 'Full') %>% # Both kinase, and condition are taken into account 
    ggplot(aes(x=r.squared)) + 
    geom_density(fill='blue', alpha=.5) +
    ggtitle('Percentage of variance explained by the full model')
```
 
 Okay, so for most genes, the model does well. For what genes does it perform badly?
 
Lets look at an example of strong and week performace:

```{r, echo=FALSE}
library(stringr)
library(gridExtra)
library(RGraphics)
library(ggrepel)

expression_plot = function(gene, measurements, t2g) {
orf = t2g$Gene[t2g$name == gene]
description = t2g$description[t2g$name == gene]
dat = measurements %>% dplyr::filter(Gene == orf)
p_heatmap = ggplot(dat, aes(y=Condition, x = Strain)) +
            geom_tile(aes(fill=Expression)) +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))

p_cond_box = ggplot(dat, aes(x = Condition, y = Expression)) +
             geom_boxplot() +
             geom_text_repel(aes(label = condition_outlier), size=2, na.rm = TRUE) +
             coord_flip() +
             theme(axis.text.x = element_blank())
             

p_strain_box = ggplot(dat, aes(x = Strain, y = Expression)) +
               geom_boxplot() +
               geom_text_repel(aes(label = strain_outlier), size=2, na.rm = TRUE) +
               theme(axis.text.x = element_text(angle = 90, hjust = 1))

text = paste0(gene, " (", orf, "): ", description)
p_desc = ggplot() +
 annotate("text", x = 4, y = 25, size=8, label = text)

grid.arrange(p_heatmap + theme(legend.position="none", axis.text.x=element_blank(), axis.text.y=element_blank()),
          p_cond_box,
          p_strain_box + theme(legend.position="none", axis.text.y=element_blank()),
          textGrob(do.call(paste, c(as.list(strwrap(text, width = 0.7 * getOption("width"))), sep="\n"))), nrow=2, ncol=2)
}

residual_plot = function(gene, all, t2g) {
  orf = t2g$Gene[t2g$name == gene]
  dat = all %>% dplyr::filter(Gene == orf) %>% separate(sample_id, c('Condition', 'Strain'), sep = '_')

  p_heatmap1 = ggplot(dat %>% filter(residual_type == 'Base'), aes(x = Strain, y = Condition, fill = residual)) +
                geom_tile() +
                scale_fill_gradient2(low = ('cyan'), mid = 'black', high = 'yellow') +
                theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                labs(fill = "Residual") +
                ggtitle("Expression ~ 1")

  p_heatmap2 = ggplot(dat %>% filter(residual_type == 'Strain'), aes(x = Strain, y = Condition, fill = residual)) +
                geom_tile() +
                scale_fill_gradient2(low = ('cyan'), mid = 'black', high = 'yellow') +
                theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                labs(fill = "Residual") +
                ggtitle("Expression ~ Strain")

  p_heatmap3 = ggplot(dat %>% filter(residual_type == 'Condition'), aes(x = Strain, y = Condition, fill = residual)) +
                geom_tile() +
                scale_fill_gradient2(low = ('cyan'), mid = 'black', high = 'yellow') +
                theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                labs(fill = "Residual") +
                ggtitle("Expression ~ Condition")

  p_heatmap4 = ggplot(dat %>% filter(residual_type == 'Full'), aes(x = Strain, y = Condition, fill = residual)) +
                geom_tile() +
                scale_fill_gradient2(low = ('cyan'), mid = 'black', high = 'yellow') +
                theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                labs(fill = "Residual") +
                ggtitle("Expression ~ Strain + Condtion")



  grid.arrange(p_heatmap1, #+ theme(legend.position="none", axis.text.x=element_blank(), axis.text.y=element_blank()),
               p_heatmap2, #+ theme(legend.position="none", axis.text.x=element_blank(), axis.text.y=element_blank()),
               p_heatmap3, #+ theme(legend.position="none", axis.text.x=element_blank(), axis.text.y=element_blank()),
               p_heatmap4) #+ theme(legend.position="none", axis.text.x=element_blank(), axis.text.y=element_blank()))
}

```

 
```{r}
model_quality %>% left_join(t2g) %>%
    filter(model_type == 'Full') %>%
    select(Gene, name, r.squared) %>% 
    arrange(r.squared) %>% head(5) %>% knitr::kable(caption = 'Worst Models')
```

Lets take a look at NAT3

\newpage

\blandscape

```{r, fig.width=11, fig.height=8, echo=FALSE}
expression_plot('NAT3', measurements, t2g)
```

\newpage

```{r, fig.width=11, fig.height=8, echo=FALSE}
residual_plot('NAT3', std_residuals, t2g)
```

\elandscape

\newpage

```{r}
model_quality %>% left_join(t2g) %>%
    filter(model_type == 'Full') %>%
    select(Gene, name, r.squared) %>% 
    arrange(-r.squared) %>% head(5) %>% knitr::kable(caption = 'Best Models')
```

Lets take a look at HBN1

\newpage

\blandscape

```{r, fig.width=11, fig.height=8, echo=FALSE}
expression_plot('HBN1', measurements, t2g)
```

\newpage

```{r, fig.width=11, fig.height=8, echo=FALSE}
residual_plot('HBN1', std_residuals, t2g)
```

\elandscape

\newpage



What makes the model week? for very low scores (<.4) we generally see taht this is dominated by genes with low expression values. 

But are there any __features__ of the genes that have low scores? $R^2$ is a general thing for all 300 data points, so its not like its pulling out massive outliers (FUS1 and HSP12 have very hight $R^2$)

Proving that this model is actually performing well:

What is the R^2 for this data vs data that is row shuffled, column shuffled, or completely shuffled?
